# 4. Apply dispersal
H_next <- K %*% H
# 5. Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c()
# 3. Initial host distribution
H <- rep(0, nrow(landscape))
H[43] <- 1
H[1] <- 1
# 4. Apply dispersal
H_next <- K %*% H
# 5. Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c()
# Sparsify dispersal
sparse_kernel <- function(landscape, d_bar_x, maxdist_mult = 4) {
coords <- st_coordinates(st_centroid(landscape))
n <- nrow(coords)
maxdist <- maxdist_mult * d_bar_x
# neighbors within maxdist (excludes self)
nb <- dnearneigh(coords, 0, maxdist, longlat = FALSE)
# build pair lists (include self as destination)
rows <- rep(seq_len(n), lengths(nb) + 1)    # +1 for self
cols <- unlist(lapply(seq_len(n), function(i) c(i, nb[[i]])))
# compute distances for those pairs
diffxy <- coords[rows, , drop = FALSE] - coords[cols, , drop = FALSE]
dists <- sqrt(rowSums(diffxy * diffxy))
# compute kernel weights (no row normalization -> absorbing)
weights <- dispersal_kernel(dists, d_bar_x)
# assemble sparse matrix (rows = origin, cols = destination)
K <- sparseMatrix(i = rows, j = cols, x = weights, dims = c(n, n))
return(K)   # rows may sum < 1 => absorbing outflow
}
?dnearneigh
??dnearneigh
library(sf)
library(spdep)
library(Matrix)
?dnearneigh
nb <- dnearneigh(x = coords, d1 = 0, d2 = maxdist, longlat = FALSE) # only consider those within range
maxdist <- maxdist_mult * d_bar_x # max dispersal distance
maxdist_mult = 4
maxdist <- maxdist_mult * d_bar_x # max dispersal distance
d_bar_x <- 1.5
maxdist <- maxdist_mult * d_bar_x # max dispersal distance
coords <- st_coordinates(st_centroid(landscape)) # Set coordinates to cell centroids
seq_len(n)
n=10
seq_len(n)
1:n
lengths(n)
?lengths
length(n)
# build pair lists (include self as destination)
rows <- rep(1:n, length(nb) + 1)    # +1 for self
nb <- dnearneigh(x = coords, d1 = 0, d2 = maxdist, longlat = FALSE) # only consider those within range
# build pair lists (include self as destination)
rows <- rep(1:n, length(nb) + 1)    # +1 for self
source("code/model.R")
# Generate the landscape
landscape <- create_hex_landscape()
source("code/mapping.R")
source("code/model.R")
# Generate the landscape
landscape <- create_hex_landscape()
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Dispersal
debugonce(build_sparse_kernel)
# Dispersal
debugonce(sparse_kernel)
K <- sparse_kernel(landscape, d_bar_x = 1.5)
# Dispersal
debugonce(sparse_kernel)
K <- sparse_kernel(landscape, d_bar_x = 1.5)
# Dispersal
debugonce(sparse_kernel)
K <- sparse_kernel(landscape, d_bar_x = 1.5)
# Dispersal
debugonce(sparse_kernel)
K <- sparse_kernel(landscape, d_bar_x = 1.5)
length(rows)
length(cols)
length(rows)
# Dispersal
debugonce(sparse_kernel)
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/model.R")
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/model.R")
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/model.R")
K <- sparse_kernel(landscape, d_bar_x = 1.5)
n=10
1:n
seq_len(n)
?rep
?sapply
# Example usage:
# landscape <- create_hex_landscape()
# K_sparse <- build_sparse_kernel(landscape, d_bar_x = 1.5, maxdist_mult = 4)
# H <- numeric(nrow(landscape)); H[30] <- 1
# H_next <- as.numeric(K_sparse %*% H)
#
nb <- list(
c(2, 3),  # neighbors of cell 1
c(1),     # neighbors of cell 2
integer(0) # neighbors of cell 3
)
n <- length(nb)
nb
n <- length(nb)
n
lapply(X = seq_len(n), FUN = function(i) { i })
?unlist
source("code/model.R")
source("code/mapping.R")
source("code/model.R")
# Generate the landscape
landscape <- create_hex_landscape()
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/model.R")
K <- sparse_kernel(landscape, d_bar_x = 1.5)
cols
rows
source("code/model.R")
source("code/model.R")
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/model.R")
K <- sparse_kernel(landscape, d_bar_x = 1.5)
# 3. Initial host distribution
H <- rep(0, nrow(landscape))
H[43] <- 1
# 4. Apply dispersal
H_next <- K %*% H
# 5. Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c()
H[1] <- 1
# 4. Apply dispersal
H_next <- K %*% H
# 5. Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c()
ggplot() + # visualise
geom_sf(data = landscape, aes(fill = habitat), colour = "black", linewidth = 0) +
scale_fill_manual(values = c("good" = "black", "bad" = "white")) +
theme_void()
source("code/mapping.R")
source("code/model.R")
# Generate the landscape
landscape <- create_hex_landscape()
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
visualise_landscape
g <- visualise_landscape()
g <- visualise_landscape(landscape)
g
# Generate the landscape
landscape <- create_hex_landscape()
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Dispersal
K <- sparse_kernel(landscape, d_bar_x = 1.5)
# 3. Initial host distribution
H <- rep(0, nrow(landscape))
H[43] <- 1
H[1] <- 1
# 4. Apply dispersal
H_next <- K %*% H
# 5. Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c()
# Generate the landscape
landscape <- create_hex_landscape()
centroids <- st_coordinates(st_centroid(landscape))
source("code/mapping.R")
source("code/model.R")
# Generate the landscape
landscape <- create_hex_landscape()
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[43] <- 1
H[1] <- 1
source("code/mapping.R")
source("code/model.R")
# Generate and process the landscape
landscape <- create_hex_landscape()
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[43] <- 1
H[1] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c()
c(H[43],H[1]) <- c(1,1)
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[c(1, 33, 38, 39, 43)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c()
source("code/mapping.R")
source("code/model.R")
install.packages("spdep")
source("code/mapping.R")
source("code/model.R")
# Generate and process the landscape
landscape <- create_hex_landscape()
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[c(1, 33, 38, 39, 43)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c()
H[c(1, 43)] <- 1
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[c(1, 43)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c()
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c() + theme_minimal()
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c() + theme_void()
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",scale = 0.5,cellsize = 8)
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",scale = 0.5,cellsize = 8)
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
?st_intersects
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
library(dplyr)
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
library(spdep)
library(sf)
# 1. check hex count vs centroids
n_hex <- nrow(hex_sf)
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(landscape))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(landscape))
centroids <- st_coordinates(st_point_on_surface(landscape))
centroids <- st_coordinates(st_centroid(landscape))
centroids <- st_coordinates(st_centroid(st_geometry(landscape)))
coords <- as.matrix(st_coordinates(st_point_on_surface(landscape))[,1:2])
centroids <- st_coordinates(st_centroid(st_geometry(landscape)))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(st_geometry(landscape)))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/model.R")
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(st_geometry(landscape)))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(st_geometry(landscape)))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(st_geometry(landscape)))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
source("code/mapping.R")
source("code/model.R")
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
centroids <- st_coordinates(st_centroid(st_geometry(landscape)))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1.5)
View(coords)
View(landscape)
View(nb)
View(nb)
View(landscape)
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 20)
source("code/model.R")
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 20)
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[c(1, 43)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c() + theme_void()
H[c(1, 143)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c() + theme_void()
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[c(1, 243)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c() + theme_void()
visualise_landscape(landscape)
H[c(1, 240)] <- 1
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[c(1, 240)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c() + theme_void()
H[c(1, 246)] <- 1
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[c(1, 246)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c() + theme_void()
H[c(1, 246, 245)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c() + theme_void()
visualise_landscape(landscape)
# Load an image
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 8) # set cellsize <8 to make a finer hex grid overlay
centroids <- st_coordinates(st_centroid(st_geometry(landscape)))
dist_mat <- as.matrix(dist(centroids))
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 20)
# Initialize host distribution
H <- rep(0, nrow(landscape))
H[c(1, 246, 245)] <- 1
# Disperse
H_next <- K %*% H
# Visualize
landscape$H <- as.numeric(H_next)
ggplot(landscape) + geom_sf(aes(fill = H)) + scale_fill_viridis_c() + theme_void()
10.2%%20
10.2%%5
10.2%%8
sf:::check_append_delete |>View()
dbscan
source("code/mapping.R")
source("code/model.R")
# Load an image as landscape
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 80) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
# Load an image as landscape
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 80) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
View(landscape)
# Load an image as landscape
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 25) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
# Load an image as landscape
landscape <- load_landscape("images/blobs.png",
scale = 0.5,# Set scale <1 to shrink image
cellsize = 80) # set cellsize <8 to make a finer hex grid overlay
visualise_landscape(landscape)
View(landscape)
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1)
source("code/mapping.R")
source("code/model.R")
# Generate sparse dispersal kernel
K <- sparse_kernel(landscape, d_bar_x = 1)
# Generate sparse dispersal kernel
K <- compute_sparse_distance(landscape, d_bar_x = 1)
